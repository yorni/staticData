<html>
  <head>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-stock.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-data-adapter.min.js"></script>
    <script src="https://cdn.anychart.com/locale/2.0.1/en-us.js"></script>

    <link
      href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css"
      type="text/css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css"
      type="text/css"
      rel="stylesheet"
    />
    <style type="text/css">
      html,
      body,
      #container {
        width: 100%;
        height: 300px;
        margin: 0;
        padding: 0;
      }

      html,
      body,
      #containerDepth {
        width: 100%;
        height: 250px;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <label for="ticker">Ticker:</label>
    <select name="ticker" id="ticker">
      <option value="BTCUSDT">BTCUSDT</option>
      <option value="SOLUSDT">SOLUSDT</option>
      <option value="GMTUSDT" selected>GMTUSDT</option>
    </select>
    <label for="depthPercent">Depth percent:</label>
    <select name="depthPercent" id="depthPercent">
      <option value="0.1">0.1</option>
      <option value="0.2">0.2</option>
      <option value="0.3">0.3</option>
      <option value="0.4">0.4</option>
      <option value="0.5">0.5</option>
      <option value="1" selected>1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="start">Start from:</label>

    <input
      type="text"
      id="start"
      name="start"
      required
      minlength="0"
      maxlength="20"
      size="10"
      value="1652505000000"
    />
    <label for="end">Ends on:</label>

    <input
      type="text"
      id="end"
      name="end"
      required
      minlength="0"
      maxlength="20"
      size="10"
      value="1652508000000"
    />
    <button onclick="getData()">Load data</button>
    <button onclick="realtimeData()">Realtime data</button>
    <div id="container"></div>
    <div id="containerDepth"></div>

    <script>
      let xVal = -1;
      let dataTableStock = anychart.data.table();
      let dataSetTrades = anychart.data.set();
      var dataSetAsks = anychart.data.set();
      var dataSetBids = anychart.data.set();
      var dataSetSO = anychart.data.set();
      let chartsLoaded = false;
      let ticker = "GMTUSDT";
      let percentDepth = "1";
      let timerId = 0;
      anychart.onDocumentReady(function () {
        getData();
      });

      async function getData() {
        if (!chartsLoaded) {
          await drawCandlesChar();
          //await drawColumnsChart();
          await drawColumnsChartSO();
        }

        if (timerId == 0) {
          start = document.querySelector("#start").value;
          end = document.querySelector("#end").value;
        } else {
          end = new Date().getTime();
          start = end - 5000;
          console.log(start);
        }

        ticker = document.querySelector("#ticker").value;
        let url =
          "http://95.217.208.90:8000/trades/" +
          ticker +
          "/" +
          start +
          "/" +
          end;
        fetch(url)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            dataTableStock.remove(null, null);
            dataTableStock.addData(data);
          })
          .catch(function () {
            console.log("error loading data");
          });
      }
      async function drawCandlesChar() {
        // map loaded data for the ohlc series
        var mapping = dataTableStock.mapAs({
          open: 1,
          high: 1,
          low: 1,
          close: 1,
          value: 2,
        });

        // create stock chart
        var chart = anychart.stock();

        // set chart title
        chart.title(ticker + " Futures chart");

        // create first plot on the chart and set settings
        var plot = chart.plot(0);
        plot
          .height("300px")
          .yGrid(true)
          .xGrid(true)
          .yMinorGrid(true)
          .xMinorGrid(true);
        plot
          .xAxis()
          .labels()
          .format(function () {
            return anychart.format.dateTime(this.value, "yyyy.MM.dd", -3 * 60);
          });

        plot
          .crosshair()
          .xLabel()
          .format(function () {
            return anychart.format.dateTime(this.value, "hh:mm:ss", -3 * 60);
          });

        chart.tooltip().titleFormat(function () {
          return anychart.format.dateTime(
            this.points[0].x,
            "yyyy.MM.dd hh:mm:ss:SSS",
            -3 * 60
          );
        });

        // create candlestick series
        var series = plot.candlestick(mapping);
        series.name(ticker + " Futures");
        series.legendItem().iconType("rising-falling");

        ////////////////////////////////////////////////

        // set container id for the chart
        chart.container("container");
        // initiate chart drawing
        chart.draw();
        chart.listen("click", function (e) {
          //drawDepth();
          drawDepthSO();
        });
        chart.tooltip().format(function (e) {
          xVal = e.x;
        });
      }

      async function drawColumnsChart() {
        let chart = anychart.column();

        // set data
        let columnsAsks = chart.column(dataSetAsks);
        columnsAsks.color("red");
        let columnsBids = chart.column(dataSetBids);
        columnsBids.color("green");
        chart.title("Asks and Bids");
        chart.container("containerDepth");
        chart.draw();
      }

      async function drawColumnsChartSO() {
        let chart = anychart.column();

        let columnsBids = chart.column(dataSetSO.mapAs({ x: 0, value: 1 }));
        columnsBids.color("red");
        columnsBids.name("Bids");
        let columnsAsks = chart.column(dataSetSO.mapAs({ x: 0, value: 2 }));
        columnsAsks.color("green");
        columnsAsks.name("Asks");
        chart.title("Asks and Bids");
        chart.container("containerDepth");
        chart.legend().enabled(true).fontSize(13).padding([0, 0, 20, 0]);
        chart.draw();

        let chart2 = anychart.line();

        let lineQtyMarketBuy = chart2.line(
          dataSetTrades.mapAs({ x: 0, value: 1 })
        );
        lineQtyMarketBuy.color("green");
        lineQtyMarketBuy.name("lineQtyMarketBuy");

        let lineQtyMarketSell = chart2.line(
          dataSetTrades.mapAs({ x: 0, value: 2 })
        );
        lineQtyMarketSell.color("red");
        lineQtyMarketSell.name("lineQtyMarketSell");

        chart2.title("Market buy and sell quantity 60 sec");
        chart2.container("containerDepth");
        chart2.legend().enabled(true).fontSize(13).padding([0, 0, 20, 0]);
        chart2.draw();

        let chart3 = anychart.line();

        let lineVolMarketBuy = chart3.line(
          dataSetTrades.mapAs({ x: 0, value: 3 })
        );
        lineVolMarketBuy.color("green");
        lineVolMarketBuy.name("lineVolMarketBuy");

        let lineVolMarketSell = chart3.line(
          dataSetTrades.mapAs({ x: 0, value: 4 })
        );
        lineVolMarketSell.color("red");
        lineVolMarketSell.name("lineVolMarketSell");

        chart3.title("Market buy and sell volume 60 sec");
        chart3.container("containerDepth");
        chart3.legend().enabled(true).fontSize(13).padding([0, 0, 20, 0]);
        chart3.draw();

        chartsLoaded = true;
      }
      async function drawDepth() {
        let url = "http://95.217.208.90:8000/depth/" + ticker + "/" + xVal;
        fetch(url)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            dataSetAsks.data(data.asks);
            dataSetBids.data(data.bids);
          })
          .catch(function (e) {
            console.log("error loading data", e);
          });
      }
      async function drawDepthSO() {
        percentDepth = document.querySelector("#depthPercent").value;
        let url =
          "http://95.217.208.90:8000/la/" +
          ticker +
          "/" +
          percentDepth +
          "/" +
          xVal;
        fetch(url)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            dataSetSO.data(data.depth);
            dataSetTrades.data(data.trades);
          })
          .catch(function (e) {
            console.log("error loading data", e);
          });
      }

      async function drawLastDepthAndTradesActivity() {
        //getData();
        percentDepth = document.querySelector("#depthPercent").value;
        let url =
          "http://95.217.208.90:8000/la/" + ticker + "/" + percentDepth + "/0";
        fetch(url)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            dataSetSO.data(data.depth);
            dataSetTrades.data(data.trades);
            dataTableStock.remove(null, null);
            dataTableStock.addData(data.tradesGraph);
          })
          .catch(function (e) {
            console.log("error loading data", e);
          });
      }
      function realtimeData() {
        if (timerId == 0) {
          timerId = setInterval(drawLastDepthAndTradesActivity, 1000);
        } else {
          clearInterval(timerId);
          timerId = 0;
        }
      }
    </script>
  </body>
</html>
