<html>
  <head>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-stock.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-data-adapter.min.js"></script>

    <link
      href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css"
      type="text/css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css"
      type="text/css"
      rel="stylesheet"
    />
    <style type="text/css">
      html,
      body,
      #container,
      #containerDepth {
        width: 100%;
        height: 350px;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <label for="ticker">Ticker:</label>
    <select name="ticker" id="ticker">
      <option value="SOLUSDT">SOLUSDT</option>
      <option value="GMTUSDT" selected>GMTUSDT</option>
    </select>
    <label for="depthPercent">Depth percent:</label>
    <select name="depthPercent" id="depthPercent">
      <option value="0.1">0.1</option>
      <option value="0.2">0.2</option>
      <option value="0.5">0.5</option>
      <option value="1" selected>1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label for="start">Start from:</label>

    <input
      type="text"
      id="start"
      name="start"
      required
      minlength="0"
      maxlength="20"
      size="10"
      value="1652443670146"
    />
    <label for="end">Ends on:</label>

    <input
      type="text"
      id="end"
      name="end"
      required
      minlength="0"
      maxlength="20"
      size="10"
      value="1652443770146"
    />
    <button onclick="getData()">Load data</button>
    <div id="container"></div>
    <div id="containerDepth"></div>

    <script>
      let xVal = 0;
      let dataTableStock = anychart.data.table();
      var dataSetAsks = anychart.data.set();
      var dataSetBids = anychart.data.set();
      var dataSetSO = anychart.data.set();
      let chartsLoaded = false;
      let ticker = "GMTUSDT";
      let percentDepth = "1";
      anychart.onDocumentReady(function () {
        getData();
      });

      async function getData() {
        if (!chartsLoaded) {
          await drawCandlesChar();
          //await drawColumnsChart();
          await drawColumnsChartSO();
        }
        let start = document.querySelector("#start").value;
        let end = document.querySelector("#end").value;
        ticker = document.querySelector("#ticker").value;
        let url =
          "http://95.217.208.90:8000/trades/" +
          ticker +
          "/" +
          start +
          "/" +
          end;
        fetch(url)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            dataTableStock.addData(data);
          })
          .catch(function () {
            console.log("error loading data");
          });
      }
      async function drawCandlesChar() {
        // map loaded data for the ohlc series
        var mapping = dataTableStock.mapAs({
          open: 1,
          high: 1,
          low: 1,
          close: 1,
          value: 2,
        });

        // create stock chart
        var chart = anychart.stock();

        // set chart title
        chart.title("SOLUSDT Futures chart new");

        // create first plot on the chart and set settings
        var plot = chart.plot(0);
        plot
          .height("200px")
          .yGrid(true)
          .xGrid(true)
          .yMinorGrid(true)
          .xMinorGrid(true);

        // create candlestick series
        var series = plot.candlestick(mapping);
        series.name("SOLUSDT Futures");
        series.legendItem().iconType("rising-falling");

        // create second plot
        var volumePlot = chart.plot(1);
        volumePlot
          .height("200px")
          .yGrid(true)
          .xGrid(true)
          .yMinorGrid(true)
          .xMinorGrid(true);
        // set yAxis labels formatter
        volumePlot.yAxis().labels().format("{%Value}{scale:(1000)(1)|(k)}");
        // set crosshair y-label formatter
        volumePlot.crosshair().yLabel().format("{%Value}{scale:(1000)(1)|(k)}");

        // create volume series on the plot
        var volumeSeries = volumePlot.line(mapping);
        // set series settings
        volumeSeries.name("Volume");

        ////////////////////////////////////////////////

        // set container id for the chart
        chart.container("container");
        // initiate chart drawing
        chart.draw();
        chart.listen("click", function (e) {
          //drawDepth();
          drawDepthSO();
        });
        chart.tooltip().format(function (e) {
          xVal = e.x;
        });
      }

      async function drawColumnsChart() {
        let chart = anychart.column();

        // set data
        let columnsAsks = chart.column(dataSetAsks);
        columnsAsks.color("red");
        let columnsBids = chart.column(dataSetBids);
        columnsBids.color("green");
        chart.title("Asks and Bids");
        chart.container("containerDepth");
        chart.draw();
      }

      async function drawColumnsChartSO() {
        let chart = anychart.column();

        let columnsBids = chart.column(dataSetSO.mapAs({ x: 0, value: 1 }));
        columnsBids.color("green");
        columnsBids.name("Bids");
        let columnsAsks = chart.column(dataSetSO.mapAs({ x: 0, value: 2 }));
        columnsAsks.color("red");
        columnsAsks.name("Asks");
        chart.title("Asks and Bids SO");
        chart.container("containerDepth");
        chart.legend().enabled(true).fontSize(13).padding([0, 0, 20, 0]);
        chart.draw();
        chartsLoaded = true;
      }
      async function drawDepth() {
        let url = "http://95.217.208.90:8000/depth/" + ticker + "/" + xVal;
        fetch(url)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            dataSetAsks.data(data.asks);
            dataSetBids.data(data.bids);
          })
          .catch(function (e) {
            console.log("error loading data", e);
          });
      }
      async function drawDepthSO() {
        percentDepth = document.querySelector("#depthPercent").value;
        let url =
          "http://95.217.208.90:8000/depth/sop/" +
          ticker +
          "/" +
          xVal +
          "/" +
          percentDepth;
        fetch(url)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            dataSetSO.data(data);
          })
          .catch(function (e) {
            console.log("error loading data", e);
          });
      }
    </script>
  </body>
</html>
